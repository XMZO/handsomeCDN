(function(){'use strict';const CFG={sources:Array.from({length:85},(_,i)=>`https://cdn.loli-con.cn/videos/background${i+1}.webm`),cacheIntervalMs:36e5,eggProbability:.01,eggImage:"https://cdn.loli-con.cn/imgs/H.webp",eggMessage:"🎉 恭喜发现彩蛋！🥵🥵🥵",specialVideos:[60,80,81].map(n=>`https://cdn.loli-con.cn/videos/background${n}.webm`),retry:{maxAttempts:2e1,baseDelayMs:1e3,maxDelayMs:3e4},injectCSS:!1,respectUserPreferences:!0,pauseOnHidden:!0,uiStyle:"original",autoUnmuteOnFirstClick:!0,showFirstUnmuteBanner:!0};const ua=navigator.userAgent||"",isCrawler=/Googlebot|Bingbot|Slurp|DuckDuckBot|Baiduspider|YandexBot|Sogou|Exabot|Chrome-Lighthouse|HeadlessChrome|PhantomJS|facebot|ia_archiver/i.test(ua),isMobileOrTablet=window.matchMedia&&matchMedia("(pointer:coarse)").matches||/Mobi|Android|iPhone|iPad|iPod/i.test(ua),prefersReducedMotion=CFG.respectUserPreferences&&window.matchMedia&&matchMedia("(prefers-reduced-motion: reduce)").matches,saveData=CFG.respectUserPreferences&&!!(navigator.connection&&navigator.connection.saveData);if(isCrawler||isMobileOrTablet||prefersReducedMotion||saveData){showEgg(CFG.eggMessage,CFG.eggImage);return}const cached=getCachedVideo(),selected=cached||pickAndCacheRandomVideo(CFG.sources,CFG.cacheIntervalMs);if(!selected){showEgg(CFG.eggMessage,CFG.eggImage);return}if(CFG.injectCSS)injectMinimalCSS();try{const preload=document.createElement("link");preload.rel="preload",preload.as="video",preload.href=selected,preload.type="video/webm",document.head.appendChild(preload)}catch(_){ }const videoEl=document.createElement("video");videoEl.id="DynamicWallpaper",videoEl.src=selected,videoEl.autoplay=!0,videoEl.muted=!0,videoEl.loop=!0,videoEl.preload="auto",videoEl.playsInline=!0,videoEl.setAttribute("aria-hidden","true"),videoEl.disablePictureInPicture=!0,safeLoadAndPlay(videoEl),attachRetryWithBackoff(videoEl,CFG.retry),CFG.pauseOnHidden&&document.addEventListener("visibilitychange",()=>{if(document.hidden)try{videoEl.pause()}catch(_){}else try{videoEl.play()}catch(_){}});const clickToPlay=()=>{videoEl.isConnected&&videoEl.paused&&videoEl.play().catch(()=>{})};document.addEventListener("click",clickToPlay,{passive:!0}),CFG.specialVideos.includes(selected)&&mountUnmuteButton(videoEl),document.body.appendChild(videoEl);function getCachedVideo(){try{const raw=localStorage.getItem("randomVideoData");if(!raw)return"";const{video,time}=JSON.parse(raw);return!video||!time||Date.now()-time>CFG.cacheIntervalMs?"":video}catch(_){return""}}function pickAndCacheRandomVideo(sources,intervalMs){const video=Math.random()<CFG.eggProbability?"":sources[Math.floor(Math.random()*sources.length)];try{localStorage.setItem("randomVideoData",JSON.stringify({video,time:Date.now(),ttl:intervalMs}))}catch(_){ }return video}function injectMinimalCSS(){try{const css="#DynamicWallpaper{position:fixed;inset:0;min-width:100vw;min-height:100vh;object-fit:cover;z-index:-1;pointer-events:none;}",style=document.createElement("style");style.textContent=css,document.head.appendChild(style)}catch(_){}}function safeLoadAndPlay(video){try{video.load()}catch(_){ }try{video.play()}catch(_){}}function attachRetryWithBackoff(video,retryCfg){let attempts=0;video.addEventListener("error",()=>{if(++attempts>retryCfg.maxAttempts){console.warn("[video-bg] 加载失败次数过多，停止重试。");return}const delay=Math.min(retryCfg.maxDelayMs,retryCfg.baseDelayMs*Math.pow(2,attempts-1));console.warn(`[video-bg] 加载错误，${delay}ms 后重试（第 ${attempts}/${retryCfg.maxAttempts} 次）…`),setTimeout(()=>{safeLoadAndPlay(video)},delay)})}function mountUnmuteButton(video){let isFirstUnmute=!0,hasUnmutedOnceByDoc=!1;function showFirstUnmuteBanner(){if(!CFG.showFirstUnmuteBanner||!isFirstUnmute)return;const n=document.createElement("div");n.textContent="😮发现特殊动态背景，已开启声音！",n.style.cssText=["position:fixed","bottom:80px","right:20px","background:linear-gradient(135deg, rgba(255,0,0,0.2), rgba(0,255,0,0.2), rgba(0,0,255,0.2))","backdrop-filter:blur(10px)","color:#FF69B4","padding:8px 16px","border-radius:8px","z-index:9999","font-size:12px","box-shadow:0 4px 15px rgba(0,0,0,0.2)","border:1px solid rgba(255,255,255,0.2)"].join(";"),document.body.appendChild(n),setTimeout(()=>n.remove(),3e3)}function toggleMute(ev){ev&&ev.stopPropagation(),video.muted=!video.muted,btn.textContent=video.muted?"🔇":"🔊",btn.setAttribute("aria-pressed",String(!video.muted)),video.muted||(isFirstUnmute=!1,video.play().catch(()=>{}),showFirstUnmuteBanner())}const btn=document.createElement("button");btn.type="button",btn.id="DynamicWallpaperUnmute",btn.setAttribute("aria-pressed","false"),btn.setAttribute("aria-label","切换背景视频静音状态"),btn.textContent=video.muted?"🔇":"🔊";if("original"===CFG.uiStyle){btn.style.cssText=["position:fixed","bottom:20px","right:120px","background:rgba(255,255,255,0.3)","backdrop-filter:blur(10px)","color:black","border:none","padding:8px 12px","border-radius:50%","cursor:pointer","z-index:9999","font-size:14px","box-shadow:0 2px 10px rgba(0,0,0,0.1)","transition:opacity .3s ease","opacity:0.9"].join(";");let hideTimeout;btn.addEventListener("mouseenter",()=>{clearTimeout(hideTimeout),btn.style.opacity="1"}),btn.addEventListener("mouseleave",()=>{hideTimeout=setTimeout(()=>{btn.style.opacity="0"},3e3)})}else btn.style.position="fixed",btn.style.bottom="20px",btn.style.right="20px",btn.style.background="rgba(0,0,0,0.5)",btn.style.color="#fff",btn.style.border="1px solid rgba(255,255,255,0.3)",btn.style.borderRadius="8px",btn.style.padding="8px 10px",btn.style.fontSize="14px",btn.style.cursor="pointer",btn.style.zIndex="9999",btn.style.backdropFilter="blur(4px)",btn.style.transition="opacity .3s ease",btn.style.opacity="0.9",btn.addEventListener("mouseenter",()=>{btn.style.opacity="1"}),btn.addEventListener("mouseleave",()=>{btn.style.opacity="0.9"});btn.addEventListener("click",toggleMute),CFG.autoUnmuteOnFirstClick&&document.addEventListener("click",()=>{video.muted&&!hasUnmutedOnceByDoc&&(hasUnmutedOnceByDoc=!0,toggleMute())},{passive:!0}),document.body.appendChild(btn)}function showEgg(message,imageUrl){const wrap=document.createElement("div");wrap.style.textAlign="center",wrap.style.marginTop="20%";const p=document.createElement("p");p.textContent=message;const img=document.createElement("img");img.src=imageUrl,img.alt="彩蛋图片",wrap.appendChild(p),wrap.appendChild(img),document.body.appendChild(wrap)}})();